<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <ul id="users"></ul>
    <script>
        // console.log('localstorage');
        window.onload = function () {
            const usersUL = document.getElementById('users');
            const users = JSON.parse(localStorage.getItem('users'));
            const version = Number(localStorage.getItem('version'));
            console.log(version);
            // localStorage.setItem('version',);
            // 但是服务器端内容改变了怎么办?
            fetch('/version')
                .then(data =>data.json())
                .then(data =>{
                    if(version){
                        // console.log(typeof(version));
                        // console.log(typeof(data));
                        // console.log(version);
                        // console.log(data);
                        // console.log(version == data);    
                        if( version == data){
                            console.log('使用本地缓存');
                            if(users){
                                console.log('已经缓存了');
                                usersUL.innerHTML = users.map(user => `
                                    <li>
                                        ${user.username} - ${user.hometown}
                                    </li>
                                `).join('');
                                return;
                            }
                            fetch('/users')
                                .then(data => data.json())
                                .then(data => {
                                // console.log(data);
                                localStorage.setItem('users', JSON.stringify(data));
                                usersUL.innerHTML = data.map(user => `
                                    <li>
                                        ${user.username} -  ${user.hometown}
                                    </li>
                                `).join('');
                                })   
                            }
                    }
                    localStorage.setItem('version', JSON.stringify(data));
                    fetch('/users')
                        .then(data => data.json())
                        .then(data => {
                        // console.log(data);
                        localStorage.setItem('users', JSON.stringify(data));
                        usersUL.innerHTML = data.map(user => `
                                <li>
                                    ${user.username} -  ${user.hometown}
                                </li>
                            `).join('');
                        })   
                })
        }
    </script>
</body>

</html>